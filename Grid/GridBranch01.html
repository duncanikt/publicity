  <!DOCTYPE html>
  <html>
  <head>
    <title>Table Example</title>
    <style>
      input[type="text"][readonly] {
        background-color: rgb(190, 189, 189);
      }
      table {
        border-collapse: collapse;
        width: 800px;  /* width: 90%; */
        table-layout: fixed;
        box-sizing: border-box;
      }
      td input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      }
      th, td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
      }

      body {
        background-color: rgb(185, 175, 241);
        padding: 20px;
      }

      tr.selected {
        background-color: yellow;
      }

      .button-container {
        display: none;
      }

      .button-container button {
        margin-right: 5px;
      }

      .select-cell {
        border-top: 1px solid transparent;
        border-bottom: 1px solid transparent;
        border-right: 1px solid transparent;
        /* width: 10px;    /*單獨調整第6欄的寬度 */
       /*  text-align: center; 文字置中 */
      }

      .hidden {
      display: none;
      }


    </style>
  </head>

  <body>
    <div>
      <label for="searchInput">單號:</label>
      <input type="text" id="searchInput" name="searchInput">
      <label for="startDate">開始日期:</label>
      <input type="date" id="startDate" name="startDate">
      <label for="endDate">結束日期:</label>
      <input type="date" id="endDate" name="endDate">
      <button onclick="search()">查詢</button>
      <button id="addButton" onclick="toggleAddContainer()">新增</button>
      <span style="padding-left:100px;"></span>
    </div>
    <br>
    <div id="addContainer" class="hidden">
      <table>
        <tbody>
          <tr>
            <td><label for="newCol1">ABC</label></td>
            <td><label for="newCol2">NameABC</label></td>
            <td><label for="newCol3">NameABCTW</label></td>
            <td><label for="newCol4">NameABCEng</label></td>
            <td><label for="newCol5">Date</label></td>

          </tr>
          <tr>
            <td><input type="text" id="newCol1" readonly></td>
            <td><input type="text" id="newCol2"></td>
            <td><input type="text" id="newCol3"></td>
            <td><input type="text" id="newCol4"></td>
            <td><input type="date" id="newCol5"></td>
          </tr>
          <tr>
            <td colspan="5" style="text-align: right;">
              <button onclick="saveRecord()">Save</button>
              <button id="cancelAdd" onclick="cancelAdd()">Cancel</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <br>
    <div id="tableContainer">
      <table id="myTable">


        <colgroup> <!-- 添加 colgroup 元素 -->
          <!-- 设置前五列的宽度 -->
          <col style="width: auto;">
          <col style="width: auto;">
          <col style="width: auto;">
          <col style="width: auto;">
          <col style="width: auto;">
          <!-- 设置最后一列的初始宽度 -->
          <col class="last-column" style="width: 100px;">
        </colgroup>



        <thead>
          <tr>
            <!-- 欄位標題 -->
          </tr>
        </thead>
        <tbody>
          <!--  資料行將以動態方式插入此處  -->
        </tbody>
      </table>
    </div>

    <!-- <div id="buttonContainer" class="button-container">
      <button onclick="updateRecord()">修改</button>
      <button onclick="cancelUpdate()">取消</button>
    </div> -->
    
    <script>
      search()
      var selectedRowData = null;

      function search() {
        // document.getElementById('buttonContainer').style.display = 'none';

        var searchInput = document.getElementById('searchInput').value;

        // 檢查單號是否為數字
        if (isNaN(searchInput)) {
          alert('單號只能輸入數字');
          return;
        }

        var startDate = document.getElementById('startDate').value;
        var endDate = document.getElementById('endDate').value;

        // 根據輸入的條件發送請求，獲取資料
        var url = 'http://localhost:8081/data?search=' + searchInput + '&startDate=' + startDate + '&endDate=' + endDate;

        fetch(url)
          .then(function(response) {
            return response.json();
          })
          .then(function(data) {
            var table = document.getElementById('myTable');
            var tableHeader = table.getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
            var tableBody = table.getElementsByTagName('tbody')[0];

            // 清空表格內容
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';

            // 動態生成列標題
            for (var key in data.recordset[0]) {
              var th = document.createElement('th');
              th.textContent = key;
              tableHeader.appendChild(th);
            }

            // 動態生成資料行
            for (var i = 0; i < data.recordset.length; i++) {
              var rowData = data.recordset[i];
              var newRow = tableBody.insertRow(i);

              for (var key in rowData) {
                var cell = newRow.insertCell();
                var value = rowData[key];

                // 轉換日期字串為 Date 物件
                if (key === 'Date') {
                  value = new Date(value);
                  // 创建修改按钮
                  var selectCell = newRow.insertCell();
                  selectCell.style.width = '50px';
                  selectCell.className = 'select-cell';
                  var selectButton = document.createElement('button');
                  selectButton.innerText = '修改';
                  selectCell.appendChild(selectButton);
                  selectButton.onclick = function() {
                    toggleButton(this);
                  };
                  // 创建删除按钮
                  var deleteButton = document.createElement('button');
                  deleteButton.innerText = '刪除';
                  deleteButton.onclick = function() {
                    deleteRecord(this);
                  };
                  selectCell.appendChild(deleteButton);


                  
                }

                // 格式化日期
                if (value instanceof Date) {
                  value = value.toLocaleDateString();
                }

                // 创建带有输入框的单元格
                var input = document.createElement('input');
                input.type = 'text';
                input.name = key;
                input.value = value;
                input.readOnly = true;
                cell.appendChild(input);
                // input.style.width = '50%'; // 设置输入框的宽度为50%

                // 添加点击事件处理程序
                newRow.addEventListener('click', function() {
                  selectRow(this);
                });
              }
            }
          })
          .catch(function(error) {
            console.log('Error:', error);
          });
      }

// 儲存原始資料的變量
var originalData = {};

function toggleButton(button) {
  if (button.innerText === '修改') {
    button.innerText = '儲存';
    button.style.backgroundColor = 'red';
    button.style.color = '';

    // 保存原始資料
    var cells = button.parentNode.parentNode.getElementsByTagName('input');
    for (var j = 0; j < cells.length; j++) {
      var input = cells[j];
      originalData[input.name] = input.value;
    }

    var cancelButton = document.createElement('button');
    cancelButton.innerText = '取消';
    cancelButton.onclick = function() {
      cancelUpdate(button);
    };
    button.parentNode.appendChild(document.createElement('br')); // 新增換行元素
    button.parentNode.appendChild(document.createElement('br')); // 新增換行元素

    button.parentNode.appendChild(cancelButton);

  } else {
    // 获取当前行的所有单元格
    var cells = button.parentNode.parentNode.getElementsByTagName('input');

    // 创建包含要发送的数据的对象
    var data = {};
    data[cells[0].name] = cells[0].value; // 获取第一列数据
    for (var j = 0; j < cells.length; j++) {
      var input = cells[j];
      if (!input.readOnly) { // 只获取可编辑的单元格数据
        data[input.name] = input.value;
      }
    }

    // 发送修改请求，保存数据
    var url = 'http://localhost:8081/update';

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
      .then(function(response) {
        if (response.ok) {
          // 将按钮文本设置为"修改"
          button.innerText = '修改';
          button.style.backgroundColor = '';
          button.style.color = '';
          button.parentNode.removeChild(button.nextSibling); // 移除"取消"按钮

          search();
        } else {
          console.log('Update failed:', response.statusText);
        }
      })
      .catch(function(error) {
        console.log('Error:', error);
      });
  }
}



function cancelUpdate(button) {
  // 還原資料
  var cells = button.parentNode.parentNode.getElementsByTagName('input');
  for (var j = 0; j < cells.length; j++) {
    var input = cells[j];
    input.value = originalData[input.name];
  }

  button.innerText = '修改';
  button.style.backgroundColor = '';
  button.style.color = '';
  button.parentNode.removeChild(button.nextSibling); // 移除換行元素
  button.parentNode.removeChild(button.nextSibling); // 移除換行元素
  button.parentNode.removeChild(button.nextSibling); // 移除"取消"按鈕
}

      function selectRow(row) {
        // 清除之前选中的行样式
        var selectedRow = document.querySelector('.selected');
        if (selectedRow) {
          selectedRow.classList.remove('selected');
        }

        // 设置当前行为选中状态
        row.classList.add('selected');

        // 获取当前行的所有单元格
        var cells = row.getElementsByTagName('input');

        // 检查是否点击了"選擇"按鈕
        var selectButton = row.querySelector('button');
        if (selectButton.innerText === '修改') {
          // 将所有单元格设置为只读状态
          for (var j = 0; j < cells.length; j++) {
            var input = cells[j];
            input.readOnly = true;
          }
          // 隐藏“修改”和“取消”按钮
          // document.getElementById('buttonContainer').style.display = 'none';

          // 清空选中行的数据
          selectedRowData = null;
        } else {
          // 将所有单元格设置为可编辑状态
          for (var j = 1; j < cells.length; j++) {
            var input = cells[j];
            input.readOnly = false;
          }

          // 显示“修改”和“取消”按钮
          // document.getElementById('buttonContainer').style.display = 'block';

          // 保存选中行的数据
          selectedRowData = row;
        }
      }

      // function updateRecord() {
      //   if (!selectedRowData) {
      //     return;
      //   }

      //   // 获取当前选中行的所有单元格
      //   var cells = selectedRowData.getElementsByTagName('input');

      //   // 将输入框设置为只读状态
      //   for (var j = 0; j < cells.length; j++) {
      //     var input = cells[j];
      //     input.readOnly = true;
      //   }

      //   // 隐藏“修改”和“取消”按钮
      //   // document.getElementById('buttonContainer').style.display = 'none';

      //   // 清空选中行的数据
      //   selectedRowData = null;
      // }

      // function cancelUpdate() {
      //   if (!selectedRowData) {
      //     return;
      //   }

      //   // 获取当前选中行的所有单元格
      //   var cells = selectedRowData.getElementsByTagName('input');

      //   // 清空输入框中的数据
      //   for (var j = 0; j < cells.length; j++) {
      //     var input = cells[j];
      //     input.value = '';
      //     input.readOnly = true;
      //   }

      //   // 隐藏“修改”和“取消”按钮
      //   // document.getElementById('buttonContainer').style.display = 'none';

      //   // 清空选中行的数据
      //   selectedRowData = null;
      // }


      document.getElementById('searchInput').addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
      event.preventDefault(); // 防止默认的Enter键行为（提交表单）
      search(); // 调用查询函数
    }
  });


  

    /*
     * toggleAddContainer 函式用於切換新增資料容器的顯示狀態。
     * 若新增資料容器為隱藏狀態，則移除 'hidden' class 以顯示容器。
     * 若新增資料容器已顯示，則新增 'hidden' class 以隱藏容器。
     */
  function toggleAddContainer() {
      var addButton = document.getElementById('addButton');
      var addContainer = document.getElementById('addContainer');
      var today = new Date().toISOString().split('T')[0];
      document.getElementById('newCol5').value = today;

      if (addContainer.classList.contains('hidden')) {
        addContainer.classList.remove('hidden');
        getMaxValueFromDatabase();
      } else {
        addContainer.classList.add('hidden');
      }
    }
    /*
     * 監聽整個文件的點擊事件，當點擊的目標不是新增按鈕、新增按鈕的父節點、新增資料容器本身，以及新增資料容器內的元素時，
     * 將新增資料容器設為隱藏狀態。
     */
    document.addEventListener('click', function(event) {
      var target = event.target;
      var addButton = document.getElementById('addButton');
      var addContainer = document.getElementById('addContainer');
      var cancelAdd = document.getElementById('cancelAdd');
      if (
        target !== addButton &&                             // 目標不是「新增」按鈕本身
        target.parentNode !== addButton &&                  // 目標不是「新增」按鈕的父節點（即包含文字的元素）
        target !== addContainer &&                          // 目標不是「addContainer」本身
        !addContainer.contains(target) ||                   // 目標不是「addContainer」的子元素
        target === cancelAdd                                // 目標是「取消按鈕」元素本身
      ) {
        addContainer.classList.add('hidden');               // 隱藏新增資料容器
      }

    });
    function cancelAdd() {
      document.getElementById('newCol2').value = '';
      document.getElementById('newCol3').value = '';
      document.getElementById('newCol4').value = '';
      document.getElementById('newCol5').value = '';
    }




    function getMaxValueFromDatabase() {
      var url = 'http://localhost:8081/maxValue';
      fetch(url)
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          var maxVal = data.recordset[0].maxValue;
          var newCol1Input = document.getElementById('newCol1');
          newCol1Input.value = maxVal + 1;
        })
        .catch(function(error) {
          console.log('Error:', error);
        });
    }


    function saveRecord() {
      var newCol1 = document.getElementById('newCol1').value;
      var newCol2 = document.getElementById('newCol2').value;
      var newCol3 = document.getElementById('newCol3').value;
      var newCol4 = document.getElementById('newCol4').value;
      var newCol5 = document.getElementById('newCol5').value;

      var data = {
        newCol1: newCol1,
        newCol2: newCol2,
        newCol3: newCol3,
        newCol4: newCol4,
        newCol5: newCol5
      };

      fetch('http://localhost:8081/insert', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
        .then(function(response) {
          if (response.ok) {
            // 新增成功，弹出提示窗口
            openWindow();
            function openWindow() {
              var w_width = 200;
              var w_height = 100;
              var x = (screen.width - w_width) / 2;
              var y = (screen.height - w_height) / 2;
              var ww = 'width=' + w_width + ',height=' + w_height + ',top=' + y + ',left=' + x;
              var openWIN = window.open('', '', ww);
              openWIN.document.write('<h2 style="text-align: center;">新增成功</h2>');
              // openWIN.document.write('<button onclick="window.close()" style="display: block; margin: 0 auto;">確認</button>');
              
              setTimeout(function() {
                openWIN.close();
              }, 500); // 0.5秒后自动关闭弹窗
            }
            // 清空新增資料欄位
            document.getElementById('newCol1').value = '';
            document.getElementById('newCol2').value = '';
            document.getElementById('newCol3').value = '';
            document.getElementById('newCol4').value = '';
            document.getElementById('newCol5').value = '';

            // 隱藏新增資料容器
            document.getElementById('addContainer').classList.add('hidden');

            // 重新載入資料
            searchInput.value = newCol1; // 将新增的数据作为搜索输入值

            search();
          } else {
            console.log('Insert failed:', response.statusText);
          }
        })
        .catch(function(error) {
          console.log('Error:', error);
        });
    }




    function deleteRecord(button) {
      var row = button.parentNode.parentNode;
      var input = row.querySelector('input');
      var ABC = input.value;

      // 发送删除请求
      var url = 'http://localhost:8081/delete';

      fetch(url, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ ABC: ABC })
      })
        .then(function(response) {
          if (response.ok) {
            row.remove();
          } else {
            console.log('Delete failed:', response.statusText);
          }
        })
        .catch(function(error) {
          console.log('Error:', error);
        });
    }

    </script>
  </body>
  </html>
